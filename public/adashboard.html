<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Grocery Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .dashboard-buttons .card {
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .dashboard-buttons .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    #products-section, #users-section, #revenue-section, #recent-orders-section { display: none; }
    img { border-radius: 5px; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <header>
    <nav class="navbar navbar-dark bg-dark shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold text-white" href="#">Admin Dashboard</a>
      </div>
    </nav>
  </header>

  <!-- Dashboard -->
  <main class="container my-5">
    <!-- Dashboard Buttons -->
    <div class="row dashboard-buttons text-center mb-5">
      <div class="col-md-3 mb-3">
        <div class="card p-4 bg-primary text-white" id="user-info-btn">
          <h5>User Info</h5>
          <p class="mb-0">Manage users and details</p>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card p-4 bg-success text-white" id="revenue-btn">
          <h5>Revenue</h5>
          <p class="mb-0">View sales and profit</p>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card p-4 bg-warning text-dark" id="products-btn">
          <h5>Products Available</h5>
          <p class="mb-0">View and manage inventory</p>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card p-4 bg-danger text-white" id="outofstock-btn">
          <h5>Out of Stock</h5>
          <p class="mb-0">Check unavailable products</p>
        </div>
      </div>
    </div>

    <!-- Users Section -->
 <section id="users-section">
  <h2 class="mb-4">All Registered Users</h2>
  <div class="mb-3">
    <p><strong>Total Users: </strong><span id="total-users-count">0</span></p>
  </div>
  <table class="table table-striped table-bordered align-middle" id="users-table">
    <thead class="table-dark">
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Email</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="3" class="text-center">Loading users...</td></tr>
    </tbody>
  </table>
</section>



    <!-- Revenue Section -->
    <section id="revenue-section">
      <h2 class="mb-4">Total Revenue Summary</h2>
      <div class="card p-4 bg-light shadow-sm mb-4">
        <div class="row">
          <div class="col-md-6">
            <h4 id="total-revenue-text" class="text-success fw-bold">Loading total revenue...</h4>
          </div>
          <div class="col-md-6">
            <h4 id="total-orders-count" class="text-info fw-bold">Loading order count...</h4>
          </div>
        </div>
        <p class="mt-2 text-secondary">This amount includes all successfully placed orders.</p>
      </div>

      <h5 class="mt-4 mb-3">Order Details</h5>
      <table class="table table-striped table-bordered align-middle" id="revenue-table">
        <thead class="table-dark">
          <tr>
            <th>Order Date</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="4" class="text-center">Loading order details...</td></tr></tbody>
      </table>
    </section>

    <!-- Products Section -->
    <section id="products-section">
      <h2 class="mb-4">Manage Products</h2>
      <table class="table table-bordered align-middle" id="products-table">
        <thead class="table-dark">
          <tr>
            <th>Category</th>
            <th>Product</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Image</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h3 class="mt-5">Add New Product</h3>
      <form id="add-product-form" class="row g-3">
        <div class="col-md-3">
          <select id="product-category" class="form-control" required>
            <option value="">Select Category</option>
            <option>Vegetables</option>
            <option>Fruits</option>
            <option>Dairy</option>
            <option>Cakes</option>
          </select>
        </div>
        <div class="col-md-3">
          <input type="text" id="product-name" class="form-control" placeholder="Product Name" required />
        </div>
        <div class="col-md-2">
          <input type="number" id="product-price" class="form-control" placeholder="Price" required />
        </div>
        <div class="col-md-2">
          <input type="number" id="product-stock" class="form-control" placeholder="Stock" required />
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-success w-100">Add</button>
        </div>
      </form>
      <p id="msg" class="mt-3 fw-bold"></p>
    </section>

    <!-- Recent Orders -->
    <section id="recent-orders-section" class="mt-5">
      <h2 class="mb-4">Recent Orders</h2>
      <table class="table table-bordered align-middle" id="recent-orders-table">
        <thead class="table-dark">
          <tr>
            <th>Order Date</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="4">Loading recent ordersâ€¦</td></tr></tbody>
      </table>
    </section>
  </main>

  <script>
    const BASE_URL = "http://localhost:5000/admin";
    const PRODUCTS_API = "http://localhost:5000/products";

    // --- Fetch Users ---
  // --- Fetch Users (from backend) ---
async function fetchUsers() {
  try {
    const res = await fetch("http://localhost:5000/admin/users");
    if (!res.ok) throw new Error("Failed to fetch users");

    const data = await res.json();
    const tbody = document.querySelector("#users-table tbody");

    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3" class="text-center text-secondary">No users found.</td></tr>`;
      document.getElementById("total-users-count").textContent = 0;
      return;
    }

    tbody.innerHTML = data.map((u, i) => `
      <tr>
        <td>${i + 1}</td>
        <td>${u.name}</td>
        <td>${u.email}</td>
      </tr>
    `).join('');

    document.getElementById("total-users-count").textContent = data.length;
  } catch (err) {
    console.error("Error fetching users:", err);
    document.querySelector("#users-table tbody").innerHTML =
      `<tr><td colspan="3" class="text-center text-danger">Error loading users. Check console.</td></tr>`;
  }
}





    // --- Fetch Products ---
    async function fetchProducts() {
      const res = await fetch(PRODUCTS_API);
      const data = await res.json();
      const tbody = document.querySelector('#products-table tbody');
      tbody.innerHTML = data.map(p => `
        <tr>
          <td>${p.category}</td>
          <td>${p.name}</td>
          <td>â‚¹${p.price}</td>
          <td>${p.stock}</td>
          <td>${p.image ? `<img src="${p.image}" width="50">` : 'â€”'}</td>
          <td>
            <button class="btn btn-warning btn-sm">Edit</button>
            <button class="btn btn-danger btn-sm">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    // --- Fetch Revenue ---
    async function fetchRevenue() {
      const revRes = await fetch(`${BASE_URL}/revenuestats`);
      const stats = await revRes.json();

      document.getElementById('total-revenue-text').textContent = `ðŸ’° Total Revenue: â‚¹${stats.totalRevenue.toFixed(2)}`;
      document.getElementById('total-orders-count').textContent = `ðŸ› Total Orders: ${stats.totalOrders}`;

      const orderRes = await fetch(`${BASE_URL}/orders`);
      const orders = await orderRes.json();
      const tbody = document.querySelector('#revenue-table tbody');
      tbody.innerHTML = orders.map(o => `
        <tr>
          <td>${new Date(o.createdAt).toLocaleString()}</td>
          <td>${o.user?.name || 'Guest'}</td>
          <td>${o.items.map(i => `${i.productId?.name} (${i.quantity})`).join(', ')}</td>
          <td>â‚¹${o.totalPrice}</td>
        </tr>
      `).join('');
    }

    // --- Out of Stock ---
    async function fetchOutOfStock() {
      const res = await fetch(`${BASE_URL}/outofstock`);
      const products = await res.json();
      if (products.length > 0) {
        alert(`âš ï¸ ${products.length} product(s) out of stock:\n${products.map(p => p.name).join(', ')}`);
      } else {
        alert("âœ… Stock is full! All products are available.");
      }
    }

    // --- Navigation ---
    function showSection(id) {
      document.querySelectorAll('section').forEach(sec => sec.style.display = 'none');
      document.getElementById(id).style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.getElementById('user-info-btn').addEventListener('click', () => {
      showSection('users-section'); 
      fetchUsers();
    });
    document.getElementById('revenue-btn').addEventListener('click', () => {
      showSection('revenue-section');
      fetchRevenue();
    });
    document.getElementById('products-btn').addEventListener('click', () => {
      showSection('products-section');
         fetchProducts();
    });
    document.getElementById('outofstock-btn').addEventListener('click', () => {
      showSection('outofstock-section');
      fetchOutOfStock();
    });

    // Load Users by default
    fetchUsers();
  </script>
</body>
</html>
