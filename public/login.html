<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Grocery Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-light">

  <!-- Navbar -->
  <header>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold" href="index.html">
          <img src="images/logo.png" alt="Grocery Portal" height="40"> Grocery Portal
        </a>
      </div>
    </nav>
  </header>

  <!-- Login Section -->
  <main class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
    <div class="card shadow-sm p-4 auth-card" style="max-width: 400px; width: 100%;">
      <h3 class="text-center mb-4">Login</h3>
      <form id="loginForm">
        <!-- Email -->
        <div class="mb-3">
          <label for="email" class="form-label">Email Address</label>
          <input type="email" class="form-control" id="email" placeholder="Enter your email" required>
        </div>

        <!-- Password -->
        <div class="mb-3">
          <label for="password" class="form-label">Password</label>
          <div class="input-group">
            <input type="password" class="form-control" id="password" placeholder="Enter your password" required>
            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">üëÅ</button>
          </div>
        </div>

        <!-- Remember me -->
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="rememberMe">
          <label class="form-check-label" for="rememberMe">Remember me</label>
        </div>

        <!-- Admin login toggle -->
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="adminLogin">
          <label class="form-check-label" for="adminLogin">Admin login</label>
        </div>

        <!-- Submit -->
        <div class="d-grid">
          <button type="submit" class="btn btn-success">Login</button>
        </div>

        <!-- Signup redirect -->
        <p class="text-center mt-3">
          Don‚Äôt have an account? <a href="signup.html">Sign up here</a>
        </p>
      </form>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white text-center py-3 border-top">
    <p class="mb-0">¬© 2025 Grocery Portal. All rights reserved.</p>
  </footer>

  <!-- Axios (for HTTP requests) -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    function togglePassword() {
      const password = document.getElementById("password");
      password.type = password.type === "password" ? "text" : "password";
    }

    // Handle form submission
    document.getElementById('loginForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      await userLogin();
    });

    async function userLogin() {
      const email = document.getElementById("email").value.trim();
      const pwd = document.getElementById("password").value;
      const remember = document.getElementById("rememberMe").checked;

      if (!email || !pwd) {
        alert("Please enter email and password");
        return;
      }

        try {
        // Backend in this project exposes login at /auth/login (no /api prefix)
        const baseUrl = "http://localhost:5000"; // Change if backend runs elsewhere
        const response = await axios.post(baseUrl + "/auth/login", {
          email,
          password: pwd
        });

        const data = response.data;
        console.log("Login Response:", data);

        // Server returns { message, token, user } on success (status 200)
        if (!response || response.status !== 200 || !data.token) {
          alert((data && data.message) || "Login failed");
          return;
        }

        // Save token and user (use sessionStorage if not remembering)
        const user = data.user || {};
        if (remember) {
          localStorage.setItem("authToken", data.token);
          localStorage.setItem("user", JSON.stringify(user));
        } else {
          sessionStorage.setItem("authToken", data.token);
          sessionStorage.setItem("user", JSON.stringify(user));
        }

        // Admin handling:
        // - If server provides `user.isAdmin`, trust that.
        // - Otherwise, fall back to a local admin email list below (update as needed).
        const adminChecked = document.getElementById('adminLogin').checked;
        const serverIsAdmin = (user && user.isAdmin) === true;
        // LOCAL ADMIN LIST ‚Äî update these emails to match your admin accounts.
        const localAdminEmails = ["admin@example.com", "admin@yourdomain.com"];
        const localIsAdmin = user && user.email && localAdminEmails.includes(user.email.toLowerCase());

        const isAdmin = serverIsAdmin || localIsAdmin;

        if (adminChecked && !isAdmin) {
          // User tried to login as admin but isn't an admin account
          alert('You selected Admin login but this account is not an admin.');
          return;
        }

        // If a `returnTo` query param was provided, send the user there (useful for returning to checkout)
        const params = new URLSearchParams(window.location.search || '');
        const returnTo = params.get('returnTo');
        if (returnTo) {
          window.location.href = returnTo;
          return;
        }

        // Otherwise redirect based on admin status
        if (isAdmin) {
          window.location.href = "adashboard.html";
        } else {
          window.location.href = "dashboard.html";
        }

      } catch (err) {
        console.error("Login error:", err);
        if (err.response && err.response.data && err.response.data.message) {
          alert(err.response.data.message);
        } else {
          alert("Unable to reach server. Make sure backend is running on http://localhost:5000");
        }
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
